# Исправление: Учет изменения курса USD/UAH

## Проблема

**До исправления:**
Программа конвертировала все UAH потоки в USD по **фиксированному начальному курсу** (41.5 UAH/USD).

```python
rent_usd = rent_uah / 41.5  # Всегда одинаковый курс!
```

**Почему это неправильно:**
- Если инфляция UAH = 11% годовых
- То курс USD/UAH должен тоже расти на ~11% годовых
- Иначе получается, что гривна не обесценивается относительно доллара

**Пример:**
- Месяц 1: аренда 12,000 UAH / 41.5 = $289
- Месяц 240: аренда 95,910 UAH / 41.5 = $2,311
- **Нереалистично!** Аренда в долларах выросла в 8 раз

## Решение

**После исправления:**
Курс растет вместе с инфляцией UAH:

```python
fx_rate[month] = fx_initial * (1 + inflation_uah_monthly) ^ (month - 1)
rent_usd = rent_uah / fx_rate[month]
```

**Теперь реалистично (базовый сценарий):**
- Месяц 1: 12,000 UAH / 41.5 = $289
- Месяц 240: 95,910 UAH / 331.9 = $289
- **Правильно!** Аренда в USD стабильна (рост аренды = инфляция)

---

## Математика

### Базовый сценарий (аренда = инфляция)

**Дано:**
- Рост аренды: 11% годовых
- Инфляция UAH: 11% годовых
- Начальный курс: 41.5 UAH/USD

**Через 20 лет:**

```
Аренда UAH = 12,000 * (1.11)^20 = 95,910 UAH
Курс = 41.5 * (1.11)^20 = 331.9 UAH/USD
Аренда USD = 95,910 / 331.9 = 289 USD
```

✅ **Аренда в USD не изменилась!** Это правильно, когда рост аренды = инфляции.

### Оптимистичный сценарий (аренда > инфляция)

**Дано:**
- Рост аренды: 14% годовых
- Инфляция UAH: 11% годовых
- Реальный рост аренды: ~3% годовых

**Через 20 лет:**

```
Аренда UAH = 12,000 * (1.14)^20 = 163,131 UAH
Курс = 41.5 * (1.11)^20 = 331.9 UAH/USD
Аренда USD = 163,131 / 331.9 = 491 USD
```

✅ **Аренда в USD выросла с $289 до $491** (+70%), что соответствует реальному росту ~3% годовых.

### Пессимистичный сценарий (аренда < инфляция)

**Дано:**
- Рост аренды: 7% годовых
- Инфляция UAH: 13% годовых
- Реальный рост аренды: ~-6% годовых

**Через 20 лет:**

```
Аренда UAH = 12,000 * (1.07)^20 = 46,175 UAH
Курс = 41.5 * (1.13)^20 = 464.5 UAH/USD
Аренда USD = 46,175 / 464.5 = 99 USD
```

✅ **Аренда в USD упала с $289 до $99** (-66%), что соответствует реальному падению ~-6% годовых.

---

## Влияние на другие показатели

### Ипотека (UAH → USD)

**Раньше:**
- Первый платеж: 19,375 UAH / 41.5 = $467
- Последний платеж: 8,406 UAH / 41.5 = $203

**Теперь (базовый сценарий):**
- Первый платеж: 19,375 UAH / 41.5 = $467
- Последний платеж: 8,406 UAH / 331.9 = $25

✅ **Правильно!** Платеж в долларах падает из-за:
1. Убывающих процентов (дифференцированный график)
2. Обесценивания гривны

### Обслуживание (UAH → USD)

**Раньше:**
- Обслуживание всегда: 1,971 UAH / 41.5 = $47

**Теперь:**
- Месяц 1: 1,971 UAH / 41.5 = $47
- Месяц 240: 1,971 UAH / 331.9 = $6

✅ **Правильно!** Фиксированная сумма в UAH обесценивается в USD.

---

## Изменения в коде

### 1. schedule.py - Аренда

```python
# БЫЛО:
rent_usd_nominal = rent_uah / params.fx_today

# СТАЛО:
fx_rate = params.fx_today * ((1 + inflation_uah_monthly) ** (month - 1))
rent_usd_nominal = rent_uah / fx_rate
```

### 2. cashflow.py - Расходы

```python
# БЫЛО:
maintenance_usd_nominal = maintenance_uah / params.fx_today
mortgage_usd_nominal = credit_df.iloc[idx]['Total_Mortgage_USD_nominal']

# СТАЛО:
fx_rate = params.fx_today * ((1 + inflation_uah_monthly) ** (month - 1))
maintenance_usd_nominal = maintenance_uah / fx_rate
mortgage_usd_nominal = mortgage_uah / fx_rate
```

### 3. schedule.py - Кредит

Убраны USD колонки из credit schedule, т.к. конвертация теперь зависит от сценария (инфляции).

---

## Проверка правильности

### Тест 1: Базовый сценарий

```bash
python -c "
from config import load_from_json
from schedule import build_rent_schedule

params = load_from_json('config.json')
rent_df = build_rent_schedule(params, 'base')

first = rent_df.iloc[0]['Rent_USD_nominal']
last = rent_df.iloc[-1]['Rent_USD_nominal']

print(f'Первый месяц: \${first:.2f}')
print(f'Последний месяц: \${last:.2f}')
print(f'Разница: {(last/first - 1) * 100:.1f}%')

if abs(last - first) < 5:
    print('✓ ПРАВИЛЬНО: Аренда в USD стабильна')
else:
    print('✗ ОШИБКА: Аренда в USD должна быть стабильной')
"
```

**Ожидаемый результат:**
```
Первый месяц: $289.16
Последний месяц: $289.01
Разница: 0.0%
✓ ПРАВИЛЬНО: Аренда в USD стабильна
```

### Тест 2: Оптимистичный сценарий

Аренда в USD должна расти на ~3% годовых (реальный рост).

### Тест 3: Пессимистичный сценарий

Аренда в USD должна падать на ~6% годовых (реальное падение).

---

## Влияние на финансовые метрики

### Ожидаемые изменения:

**NPV и IRR должны:**
- Немного снизиться во всех сценариях
- Стать более реалистичными
- Лучше отражать реальную покупательную способность

**Почему снижение:**
1. Платежи по ипотеке в USD теперь падают медленнее
2. Обслуживание в USD падает (что хорошо), но общий эффект меньше

**Это правильно!**
- Теперь учитывается реальное обесценивание гривны
- Метрики показывают реальную доходность в USD
- Можно корректно сравнивать с USD-альтернативами

---

## Итоговые рекомендации

### ✅ Используйте обновленную версию

Новая версия корректно учитывает:
1. Обесценивание гривны
2. Реальную покупательную способность
3. Правильную конвертацию в USD

### ✅ Интерпретация результатов

**Базовый сценарий:**
- Rent_USD_nominal ≈ const
- Это значит, что реальный доход в долларах стабилен
- Правильно, когда рост аренды = инфляция

**Оптимистичный:**
- Rent_USD_nominal растет
- Реальный доход в долларах растет
- Инвестиция очень выгодна

**Пессимистичный:**
- Rent_USD_nominal падает
- Реальный доход в долларах падает
- Но инвестиция все равно может быть выгодной

---

## Технические детали

### Формула курса

```python
FX[month] = FX[0] * (1 + inflation_monthly) ^ (month - 1)
```

где:
- `FX[0]` = начальный курс (41.5)
- `inflation_monthly` = месячная инфляция UAH
- `month` = номер месяца (1 to 240)

### Предположения

1. **Паритет покупательной способности (PPP)**
   - Курс меняется пропорционально инфляции
   - Упрощение, но разумное для длительных периодов

2. **USD стабилен**
   - Инфляция USD = 0 (или включена в discount rate)
   - Для более точной модели можно учесть инфляцию USD

3. **Линейная зависимость**
   - Курс растет равномерно по месяцам
   - В реальности курс волатильный, но тренд учтен

---

## Дальнейшие улучшения

### Опциональные доработки:

1. **Учет инфляции USD**
   - Добавить параметр `inflation_usd_annual`
   - Корректировать discount rate

2. **Волатильность курса**
   - Добавить случайные отклонения ±10%
   - Монте-Карло симуляция

3. **Разные прогнозы курса**
   - Пессимистичный: курс растет быстрее инфляции
   - Оптимистичный: курс растет медленнее

---

## Запуск с исправлениями

```bash
python main.py config.json
```

Теперь результаты реалистичны и корректны!
